document.addEventListener('DOMContentLoaded', function() {
    if (typeof subreddit !== 'undefined') {
        const subredditTitleElement = document.getElementById('subreddit-title');
        const explanationElement = document.getElementById('subreddit-explanation');

        // NEW: Dynamically create and insert the explanation text
        explanationElement.innerHTML = `
            This page displays a live feed of the most popular ('Hot') posts from the 
            <strong>r/${subreddit}</strong> subreddit, an independent online community on Reddit. 
            The content shown is generated by users of that community and is presented unmoderated 
            to offer a real-time snapshot of the discussions engaging its members. 
            The views expressed do not necessarily reflect those of The Ledger.
        `;

        subredditTitleElement.classList.add('text-center');
        subredditTitleElement.innerHTML = `
            <a href="https://www.reddit.com/r/${subreddit}" target="_blank" rel="noopener noreferrer" class="hover:text-amber-400 transition-colors duration-300">
                r/${subreddit}
            </a>
        `;
        
        fetchSubredditInfo(subreddit);
        fetchRedditPosts(subreddit);
    } else {
        console.error('Subreddit name is not defined in the HTML page.');
        document.getElementById('subreddit-title').textContent = 'Error: Subreddit not specified.';
    }
});

async function fetchSubredditInfo(subreddit) {
    try {
        const response = await fetch(`https://www.reddit.com/r/${subreddit}/about.json`);
        if (!response.ok) {
            throw new Error(`Failed to fetch info for r/${subreddit}`);
        }
        const aboutData = await response.json();

        const statsContainer = document.createElement('div');
        statsContainer.className = 'subreddit-stats';

        const numberFormatter = new Intl.NumberFormat('en-GB', {
            notation: 'compact',
            compactDisplay: 'short'
        });

        statsContainer.innerHTML = `
            <div>
                <div class="stat-value">${numberFormatter.format(aboutData.data.subscribers)}</div>
                <div class="stat-label">Members</div>
            </div>
            <div>
                <div class="stat-value">${numberFormatter.format(aboutData.data.active_user_count)}</div>
                <div class="stat-label">Online</div>
            </div>
        `;
        
        const titleElement = document.getElementById('subreddit-title');
        titleElement.insertAdjacentElement('afterend', statsContainer);

    } catch (error) {
        console.error('Error fetching subreddit info:', error);
    }
}

async function fetchRedditPosts(subreddit) {
    const postsContainer = document.getElementById('subreddit-posts');
    try {
        const response = await fetch(`https://www.reddit.com/r/${subreddit}/hot.json?limit=12`);
        if (!response.ok) {
            throw new Error(`Subreddit not found or Reddit API error: ${response.status}`);
        }
        const data = await response.json();

        const posts = data.data.children
            .filter(child => !child.data.stickied)
            .map(child => child.data);

        displayPosts(posts);
    } catch (error) {
        console.error('Error fetching Reddit posts:', error);
        postsContainer.innerHTML = `<p class="text-red-400 text-lg">Could not load posts for r/${subreddit}. The subreddit may be private, banned, or does not exist.</p>`;
    }
}

function displayPosts(posts) {
    const container = document.getElementById('subreddit-posts');
    container.innerHTML = '';
    posts.forEach(post => {
        const postElement = document.createElement('div');
        postElement.className = 'card bg-gray-800 rounded-lg flex flex-col overflow-hidden';

        const summary = post.selftext ? post.selftext.substring(0, 150) + '...' : '';

        let thumbnailHtml = '';
        if (post.thumbnail && post.thumbnail.startsWith('http')) {
            thumbnailHtml = `
                <a href="https://reddit.com${post.permalink}" target="_blank" rel="noopener noreferrer">
                    <img src="${post.thumbnail}" alt="Post thumbnail" class="w-full h-40 object-cover">
                </a>`;
        }
        
        postElement.innerHTML = `
            ${thumbnailHtml}
            <div class="p-6 flex flex-col flex-grow">
                <h3 class="text-xl font-bold mb-3 text-gray-100">${post.title}</h3>
                ${summary ? `<p class="text-gray-400 mb-4 flex-grow">${summary}</p>` : '<div class="flex-grow"></div>'}
                <div class="mt-auto pt-4 border-t border-gray-700 flex justify-between items-center text-sm text-gray-500">
                    <span>Upvotes: ${post.score}</span>
                    <a href="https://reddit.com${post.permalink}" target="_blank" class="text-amber-400 hover:text-amber-500 font-semibold transition-colors">
                        View on Reddit &rarr;
                    </a>
                </div>
            </div>
        `;
        container.appendChild(postElement);
    });
}